<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Music Sync</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-control" content="no-cache">
  <meta http-equiv="Expires" content="-1">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  {% if data['is_index'] %}
      <script src="/static/howler.js" type="text/javascript"></script>
       <audio preload="auto" src="/static/sound.mp3?{{ data['random_integer'] }}" id="sound">
  Your browser does not support the audio tag.
</audio> 
  {% endif %}
  <link rel="stylesheet" href="/static/normalize.css">
  <link rel="stylesheet" href="/static/skeleton.css">
  </head>
  <body>

  <script>
{% if data['is_index'] %}
var time = Date.now || function() {
    return +new Date.getTime();
}


// GLOBALS
var correct_time_delta = []
var next_trigger = time() + 1000000;
var true_time_delta = 0;
var sound_activated = false;
var seconds_left = 0;
var secondTimeout3 = setTimeout(function() {
    console.log('3 seconds left')
}, 100000);
var secondTimeout2 = setTimeout(function() {
    console.log('2 seconds left')
}, 100000);
var secondTimeout1 = setTimeout(function() {
    console.log('1 seconds left')
}, 100000);
var secondTimeout0 = setTimeout(function() {
    console.log('0 seconds left')
}, 100000);


var sound = new Howl({
    urls: ['/static/sound.mp3?{{ data['random_integer'] }}'],
    onend: function() {

        var posting = $.post('/nextsong', {
            'message': 'next song please'
        });

        // Put the results in a div
        posting.done(function(data) {
            sound.unload()
            location.reload(true);
        });

    },
    buffer: true
});


function makeRequests(callback) {

    for (var i = 0; i < 5; i++) {
        // Send the data using post
        var posting = $.post('/sync', {
            'client_timestamp': time()
        });

        // Put the results in a div
        posting.done(function(data) {
            console.log(data);
            $("div.info2").text('Now playing: ' + data['current_song']);
            latency = time() - data['client_timestamp']
            half_latency = latency / 2.0
            time_delta = time() - data['server_timestamp']
            next_trigger = data['next_song']

            correct_time_delta.push(time_delta);
            var sum = 0.0;
            for (var j = 0; j < correct_time_delta.length; j++) {
                sum = sum + correct_time_delta[j];
            }

            true_time_delta = sum / correct_time_delta.length;
            console.log(true_time_delta);
            clearTimeout(secondTimeout3);
            secondTimeout3 = setTimeout(function() {
                console.log('3 seconds left');
                $("div.info1").text('3 seconds left');
            }, next_trigger - (time() - true_time_delta) - 3000);
            clearTimeout(secondTimeout2);
            secondTimeout2 = setTimeout(function() {
                console.log('2 seconds left');
                $("div.info1").text('2 seconds left');
            }, next_trigger - (time() - true_time_delta) - 2000);
            clearTimeout(secondTimeout1);
            secondTimeout1 = setTimeout(function() {
                console.log('1 seconds left');
                $("div.info1").text('1 second left');
            }, next_trigger - (time() - true_time_delta) - 1000);
            clearTimeout(secondTimeout0);
            secondTimeout0 = setTimeout(function() {
                $("div.info2").text('Now playing: ' + data['current_song']);
                console.log('playing song');
                $("div.info1").text('Playing');
                window.setInterval(function(){
                  checkIfSkipped();
                }, 3000);
                sound.play();
                var posting = $.post('/playing', {
                'message': 'im playing a song'
                });

                // Put the results in a div
                posting.done(function(data) {

                });
            }, next_trigger - (time() - true_time_delta));
        });
    }
}

makeRequests();



function checkIfSkipped() {

        // Send the data using post
        var posting = $.post('/sync', {
            'client_timestamp': time()
        });

        // Put the results in a div
        posting.done(function(data) {
          console.log(data)
          if (data['is_playing']==false) {
            sound.unload()
            location.reload(true);
          }
        });

}

{% else %}
setInterval(function() 
{ window.location=window.location;},1000);
{% endif %}

$(function () {
    $('#nextsong').on('click', function () {
        $("div.info1").text('Skipping to next song');
        $("div.info2").text('');
        var posting = $.post('/nextsong', {
            'message': 'next song please'
        });

        // Put the results in a div
        posting.done(function(data) {
            sound.unload()
            location.reload(true);
        });
    });
});



  </script>
  
<div class="container">

  <!-- columns should be the immediate child of a .row -->
  <div class="row">
  <div class="two columns">
    <button class="button" id="nextsong">Next</button>
  </div>
  <div class="ten columns">
    <div class="info1">{{ data['message'] }}</div>
  </div>
  </div>
  <div class="row">
  <div class="two columns">
  </div>
  <div class="ten columns">
    <div class="info2"></div>
  </div>
  </div>

</div>

  
  </body>
</html>



<!--
https://stackoverflow.com/questions/11001318/waiting-for-api-call-to-finish-in-javascript-before-continuing

var res = makeCall();
if(res)
{
   // do stuff
}
Do this:

function makeCall(){
    FB.api('/me/feed', 'post', { message: body }, function(response) {
        if (response && !response.error) {
            // do stuff
        }
    });
}

makeCall();
-->