<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Music Sync</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-control" content="no-cache">
  <meta http-equiv="Expires" content="-1">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/2.5.0/math.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
      <script src="/static/howler.js" type="text/javascript"></script>
      <!-- <audio preload="auto" src="/static/sound.mp3?{{ data['random_integer'] }}" id="sound">
  Your browser does not support the audio tag.
</audio> -->

  <link rel="stylesheet" href="/static/normalize.css">
  <link rel="stylesheet" href="/static/skeleton.css">
  <style>
a { cursor: pointer; }
  </style>
  </head>
  <body>

  <script>

var time = Date.now || function() {
    return +new Date.getTime();
}


// GLOBALS
var correct_time_delta = []
var correct_latency = []
var next_trigger = time() + 1000000;
var true_time_delta = 0;
var true_server_time_delta = 0;
var sound_activated = false;
var seconds_left = 0;
var secondTimeout3 = setTimeout(function() {
    console.log('3 seconds left')
}, 100000);
var secondTimeout2 = setTimeout(function() {
    console.log('2 seconds left')
}, 100000);
var secondTimeout1 = setTimeout(function() {
    console.log('1 seconds left')
}, 100000);
var secondTimeout0 = setTimeout(function() {
    console.log('0 seconds left')
}, 100000);


var sound = new Howl({
    src: ['/static/sound.mp3?{{ data['random_integer'] }}'],
    onend: function() {

        var posting = $.post('/nextsong', {
            'message': 'next song please'
        });

        // Put the results in a div
        posting.done(function(data) {
            sound.unload()
            location.reload(true);
        });

    },
    buffer: true
});


function makeRequests(callback) {

    for (var i = 0; i < 15; i++) {

      setTimeout(function postRequest() {

// Send the data using post
        var posting = $.post('/sync', {
            'client_timestamp': time()
        });

        // Put the results in a div
        posting.done(function(data) {
            latency = time() - data['client_timestamp']
            half_latency = latency / 2.0
            time_delta = time() - data['server_timestamp']
            next_trigger = data['next_song']

            correct_time_delta.push(time_delta + half_latency);
            correct_latency.push(half_latency);
            if (correct_time_delta.length==7) {
              var mean = math.mean(correct_time_delta);
              var median = math.median(correct_time_delta);
              var std = math.std(correct_time_delta);
              var sum = 0
              var num = 0
              for (var j = 0; j < correct_time_delta.length; j++) {
                  if (correct_time_delta[j]<median+std) {
                      sum = sum + correct_time_delta[j];
                      num = num + 1;
                  }
              }
              true_time_delta = sum / num;

              var mean = math.mean(correct_latency);
              var median = math.median(correct_latency);
              var std = math.std(correct_latency);
              var sum = 0
              var num = 0
              for (var j = 0; j < correct_latency.length; j++) {
                  if (correct_latency[j]<median+std) {
                      sum = sum + correct_latency[j];
                      num = num + 1;
                  }
              }
              true_server_time_delta = sum / num;

              clearTimeout(secondTimeout3);
              secondTimeout3 = setTimeout(function() {
                  console.log('3 seconds left');
                  $("div.info1").text('3 seconds left');
              }, next_trigger - (time() - true_time_delta) - 3000);
              clearTimeout(secondTimeout2);
              secondTimeout2 = setTimeout(function() {
                  console.log('2 seconds left');
                  $("div.info1").text('2 seconds left');
              }, next_trigger - (time() - true_time_delta) - 2000);
              clearTimeout(secondTimeout1);
              secondTimeout1 = setTimeout(function() {
                  console.log('1 seconds left');
                  $("div.info1").text('1 second left');
              }, next_trigger - (time() - true_time_delta) - 1000);
              clearTimeout(secondTimeout0);
              secondTimeout0 = setTimeout(function() {
                  console.log('playing song');
                  $("div.info1").text('Playing');
                  window.setInterval(function(){
                    checkIfSkipped();
                  }, 10000);
                  sound.play();
                  if (data['is_playing']==true) {
                      sound.seek(data['song_time'])
                  }
                  var posting = $.post('/playing', {
                  'message': 'im playing a song'
                  });

                  // Put the results in a div
                  posting.done(function(data) {

                  });
              }, next_trigger - (time() - true_time_delta));

            }




        });



      }, i*200 );
        
    }
}


function checkIfSkipped() {

        // Send the data using post
        var posting = $.post('/sync', {
            'client_timestamp': time()
        });

        // Put the results in a div
        posting.done(function(data) {
          if (data['is_playing']==false) {
            sound.unload()
            location.reload(true);
          } else {
            var mySongTime = sound.seek();
            var serverSongTime = data['song_time'];
            var diff = serverSongTime*1000+true_server_time_delta - mySongTime*1000;
            var seekTo = data['song_time']+true_server_time_delta/1000.0;
            console.log('Browser: ' + mySongTime.toString() + '\nServer: ' + serverSongTime.toString() + '\nHalf-Latency: ' + true_server_time_delta.toString() + '\nCorrected diff: ' + diff.toString());
            if (Math.abs(diff) > 10) {
              console.log('seeking to ' + seekTo.toString())
              sound.seek(seekTo)
            }
          }
        });

}




$(document).ready(function(){
    $('a[type=controls]').click(function() {
       var skip = $(this).data('skip');
       console.log(skip);
        $("div.info1").text('Changing song');
        var posting = $.post('/nextsong', {
            'message': 'next song please',
            'skip': parseInt(skip)
        });

        // Put the results in a div
        posting.done(function(data) {
            sound.unload()
            location.reload(true);
        });

    });


    makeRequests();

});




  </script>
  
<div class="container">

  <!-- columns should be the immediate child of a .row -->
  <div class="row">
  </div>
  <div class="row">
  <h1>Sync Music</h1>
  </div>

  <div class="row">
  <div class="six columns">
    <a class="button" type="controls" data-skip="-3">Previous</a>
    <a class="button" type="controls" data-skip="-2">Replay</a>
    <a class="button" type="controls" data-ksip="-1">Next</a>
  </div>
  <div class="six columns">
    <div class="info1">{{ data['message'] }}</div>
  </div>
  </div>
  <div class="row">
  <div class="two columns">
  </div>
  <div class="ten columns">
    <div class="info2">{{ data['playlist_html'] | safe }}</div>
  </div>
  </div>

</div>

  
  </body>
</html>



<!--
https://stackoverflow.com/questions/11001318/waiting-for-api-call-to-finish-in-javascript-before-continuing

var res = makeCall();
if(res)
{
   // do stuff
}
Do this:

function makeCall(){
    FB.api('/me/feed', 'post', { message: body }, function(response) {
        if (response && !response.error) {
            // do stuff
        }
    });
}

makeCall();
-->